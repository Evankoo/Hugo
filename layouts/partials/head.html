<head>
  <meta charset="utf-8" />
  <title>
    {{ if (eq .Site.Params.reversepagetitle true) }}
      {{ with .Title }}
        {{ . }} |
      {{ end }}
      {{- .Site.Params.author -}}
    {{ else }}
      {{- .Site.Params.author -}}{{ with .Title }}
        |
        {{ . }}
      {{ end }}

    {{ end }}

  </title>

  <!-- Meta -->
  {{- hugo.Generator -}}
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="author" content="{{ .Site.Params.author }}" />

<meta
    name="description"
    content="{{ if .Params.description }}
      {{- .Params.description -}}
    {{ else }}
      {{- .Site.Params.description -}}
    {{ end }}"
  />

  {{ if .Params.redirectUrl }}
    <meta http-equiv="refresh" content="1; url={{ .Params.redirectUrl }}" />
  {{ end }}
  {{- if .Site.Params.googleSiteVerify }}
    <meta name="google-site-verification" content="{{ .Site.Params.googleSiteVerify }}" />
  {{- end -}}

<script>
(function () {
  var NIGHT_START = 19, DAY_START = 6;

  function isNightInBeijing(d) {
    d = d || new Date();
    var hourStr = new Intl.DateTimeFormat('zh-CN', {
      hour: '2-digit', hour12: false, timeZone: 'Asia/Shanghai'
    }).format(d);
    var h = parseInt(hourStr, 10);
    return h >= NIGHT_START || h < DAY_START;
  }

  function setTheme(t) {
    document.documentElement.setAttribute('data-theme', t);
    if (document.body) document.body.setAttribute('data-theme', t); // 兼容不同主题选择器
  }

  try {
    // 若用户手动选择过主题，则尊重它（兼容常见键名）
    var userPref = localStorage.getItem('theme') || localStorage.getItem('colorscheme');
    if (!userPref) setTheme(isNightInBeijing() ? 'dark' : 'light');
  } catch (e) {
    setTheme(isNightInBeijing() ? 'dark' : 'light');
  }

  // 无手动设置时，每分钟校正一次
  setInterval(function () {
    try {
      var userPref = localStorage.getItem('theme') || localStorage.getItem('colorscheme');
      if (!userPref) setTheme(isNightInBeijing() ? 'dark' : 'light');
    } catch (e) {}
  }, 60 * 1000);
})();
</script>

  <!-- CSS -->
  {{ $contentRatio := or site.Params.contentratio 0.6 -}}
  {{ $languageDirection := or site.Language.LanguageDirection "ltr" -}}
  {{ $vars := dict
    "text_direction" $languageDirection
    "content_ratio" (printf "%f%%" (mul $contentRatio 100))
    "sidebar_ratio" (printf "%f%%" (mul (sub 1.0 $contentRatio) 100))
    "content_ratio_wide" (printf "%f%%" (mul 0.8 (mul $contentRatio 100)))
    "sidebar_ratio_wide" (printf "%f%%" (mul 0.8 (mul (sub 1.0 $contentRatio) 100)))
  -}}
  {{ $options := dict
    "transpiler" "dartsass"
    "vars" $vars
    "targetPath" (printf "css/anatole%s.css" (cond (eq site.Language.LanguageDirection "") "" (printf ".%s" site.Language.LanguageDirection)))
  -}}
  {{ with resources.Get "scss/main.scss" -}}
    {{ if hugo.IsProduction -}}
      {{ with . | toCSS $options | minify | fingerprint }}
        <link rel="stylesheet" href="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous" />
      {{ end -}}
    {{ else -}}
      {{ with . | toCSS $options }}
        <link rel="stylesheet" href="{{ .RelPermalink }}" />
      {{ end -}}
    {{ end -}}
  {{ end -}}

<!-- ⚡️ FontAwesome CDN 优化：直接引用公共库，速度快且不丢图标 -->
  <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

<!-- ⚡️ 自定义样式 (SCSS 编译模式) -->
  <!-- 注意：这段代码会自动寻找 assets/scss/custom.scss -->
  {{ with resources.Get "scss/custom.scss" | toCSS (dict "transpiler" "dartsass") }}
    {{ if hugo.IsProduction }}
      {{ $custom := . | minify | fingerprint }}
      <link rel="stylesheet" href="{{ $custom.RelPermalink }}" integrity="{{ $custom.Data.Integrity }}" crossorigin="anonymous">
    {{ else }}
      <link rel="stylesheet" href="{{ .RelPermalink }}">
    {{ end }}
  {{ end }}


{{ if .Params.redirectUrl }}
    {{ $style := resources.Get "css/spinner.css" | resources.Minify | resources.Fingerprint }}
    <link
      rel="stylesheet"
      href="{{ $style.RelPermalink }}"
      integrity="{{ $style.Data.Integrity }}"
      crossorigin="anonymous"
      type="text/css"
    />
  {{- end -}}
  {{ if .Site.Params.googleFonts }}
    {{ $baseUrl := "https://fonts.googleapis.com/css2?family=" }}
    {{ $fontParam := delimit .Site.Params.googleFonts "&family=" }}
    {{ $url := printf "%s" "&display=swap" | printf "%s%s" $fontParam | printf "%s%s" $baseUrl | printf "%s" }}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="{{ $url }}" rel="stylesheet" />
  {{- end -}}


  <!-- Favicons -->
  <link rel="shortcut icon" href="{{ .Site.Params.favicon | relURL }}favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="{{ .Site.Params.favicon | relURL }}apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="{{ .Site.Params.favicon | relURL }}favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="{{ .Site.Params.favicon | relURL }}favicon-16x16.png" />

  <link rel="canonical" href="{{ .Permalink }}" />
  <!-- License -->
  {{- with .Site.Params.license -}}
    <link rel="license" href="{{ . }}" />
  {{- end -}}


  <!-- RSS -->
  {{ with .OutputFormats.Get "rss" -}}
    {{ printf `<link rel="%s" type="%s" href="%s" title="%s" />` .Rel .MediaType.Type .RelPermalink $.Site.Title | safeHTML }}
  {{ end -}}


  <!-- JavaScript -->
  {{ $anatoleHeader := resources.Get "js/anatole-header.js" }}
  {{ $secureHeaderJS := $anatoleHeader |  resources.Minify | resources.Fingerprint }}
  <script
    type="text/javascript"
    src="{{ $secureHeaderJS.RelPermalink }}"
    integrity="{{ $secureHeaderJS.Data.Integrity }}"
    crossorigin="anonymous"
  ></script>

  {{ $animatedJS := resources.Get "js/main-animated.js" | resources.Minify | resources.Fingerprint }}
  <script
    type="text/javascript"
    src="{{ $animatedJS.RelPermalink }}"
    integrity="{{ $animatedJS.Data.Integrity }}"
    crossorigin="anonymous"
    defer
  ></script>

  {{ if not .Site.Params.disableThemeSwitcher }}
    {{ $anatoleThemeSwitcher := resources.Get "js/anatole-theme-switcher.js" }}
    {{ $secureThemeSwitcherJS := $anatoleThemeSwitcher |  resources.Minify | resources.Fingerprint }}
    <script
      type="text/javascript"
      src="{{ $secureThemeSwitcherJS.RelPermalink }}"
      integrity="{{ $secureThemeSwitcherJS.Data.Integrity }}"
      crossorigin="anonymous"
    ></script>
  {{ end }}

  {{- $js := "" -}}
  {{- range .Site.Params.customJs -}}
    {{- if or (in . "http://") (in . "https://") -}}
      <script src="{{ . | relURL }}"></script>
    {{- else -}}
      {{- $customJS := resources.Get . -}}
      {{- if $customJS -}}
        {{- if eq $js "" -}}
          {{- $js = $customJS -}}
        {{- else -}}
          {{- $js = slice $js $customJS | resources.Concat "js/custom.js" -}}
        {{- end -}}

      {{- end -}}

    {{- end -}}

  {{- end -}}

  {{- if ne $js "" -}}
    {{- $secureJS := $js |  resources.Minify | resources.Fingerprint -}}
    <script
      type="text/javascript"
      src="{{ $secureJS.RelPermalink }}"
      integrity="{{ $secureJS.Data.Integrity }}"
      crossorigin="anonymous"
    ></script>
  {{- end -}}

  {{ if and hugo.IsProduction .Site.Params.plausibleAnalytics .Site.Params.plausibleAnalytics.domain }}
    {{- partial "analytics/plausible" . -}}
  {{ end }}

  {{ if and hugo.IsProduction .Site.Params.umami.serverURL .Site.Params.umami.id }}
    {{- partial "analytics/umami" . -}}
  {{ end }}

  {{ if and hugo.IsProduction .Site.Params.Matomo.instance .Site.Params.Matomo.siteId }}
    {{- partial "analytics/matomo" . -}}
  {{ end }}

  {{ if and hugo.IsProduction .Site.Params.meta.pixelId }}
    {{- partial "analytics/meta.html" . -}}
  {{ end }}


  <!-- Twitter Cards -->
  {{ template "_internal/twitter_cards.html" . }}


  <!-- Open Graph -->
  {{ template "_internal/opengraph.html" . }}


  <!-- Schema.org-->
  {{ partial "schema.html" . }}


  <!-- KaTeX-->
  {{ $noop := .WordCount }}
  {{ if .Page.Store.Get "hasMath" }}
    {{ $katex_css_url := printf "https://cdn.jsdelivr.net/npm/katex@latest/dist/katex%s.css" (cond hugo.IsProduction ".min" "") -}}
    {{ with try (resources.GetRemote $katex_css_url) -}}
      {{ with .Err -}}
        {{ errorf "Could not retrieve KaTeX css file from CDN. Reason: %s." . -}}
      {{ else with.Value -}}
        {{ with resources.Copy (printf "css/katex%s.css" (cond hugo.IsProduction ".min" "")) . }}
          {{ $secureCSS := . | resources.Fingerprint "sha512" -}}
          <link
            rel="stylesheet"
            href="{{- .RelPermalink -}}"
            integrity="{{- $secureCSS.Data.Integrity -}}"
            crossorigin="anonymous"
          />
        {{ end -}}
      {{ end -}}
    {{ end -}}
  {{ end }}

</head>
