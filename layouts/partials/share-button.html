<!-- æ‚¬æµ®æŒ‰é’® -->
<div id="share-button" class="share-button-circle" style="top: 50%;">
  <button onclick="handleShareClick('{{ .Permalink }}')" title="åˆ†äº«/ç”Ÿæˆæµ·æŠ¥">
    <i class="fas fa-share-alt"></i>
  </button>
</div>

<!-- æµ·æŠ¥æº (éšè—) -->
<div id="poster-source-container">
  <div class="poster-card">
    
    {{/* --- ğŸ›¡ï¸ å›¾ç‰‡é€»è¾‘ï¼šæ™ºèƒ½è£åˆ‡ç‰ˆ --- */}}
    {{ $pageContext := . }}
    {{ $posterImg := "/images/profile.png" | absURL }}
    {{ $found := "" }} 

    {{/* 1. å¯»æ‰¾èµ„æº */}}
    {{ if .Resources }}
      {{ if $pageContext.Params.thumbnail }}
        {{ $found = .Resources.GetMatch $pageContext.Params.thumbnail }}
      {{ end }}
      {{ if and (not $found) $pageContext.Params.image }}
        {{ $found = .Resources.GetMatch $pageContext.Params.image }}
      {{ end }}
      {{ if not $found }}{{ $found = .Resources.GetMatch "cover*" }}{{ end }}
      {{ if not $found }}{{ $found = .Resources.GetMatch "feature*" }}{{ end }}
    {{ end }}

    {{/* 2. ç”Ÿæˆé“¾æ¥ (å…³é”®ä¿®æ”¹ç‚¹) */}}
    {{ if $found }}
      {{/* ğŸš¨ ä½¿ç”¨ Fill è€Œä¸æ˜¯ Resize */}}
      {{/* "750x400" å¯¹åº”æµ·æŠ¥å°é¢ 375x200 çš„ä¸¤å€åˆ†è¾¨ç‡ */}}
      {{/* "Smart" è¡¨ç¤º Hugo ä¼šè‡ªåŠ¨è¯†åˆ«å›¾ç‰‡ä¸»ä½“è¿›è¡Œè£åˆ‡ï¼Œè€Œä¸æ˜¯æ­»æ¿åœ°åˆ‡ä¸­é—´ */}}
      {{ $posterImg = ($found.Fill "750x400 Smart q90").Permalink }}
    {{ else }}
      {{/* å…œåº•é€»è¾‘ */}}
      {{ if .Params.thumbnail }}
        {{ $posterImg = (.Params.thumbnail | absURL) }}
      {{ else if .Params.image }}
        {{ $posterImg = (.Params.image | absURL) }}
      {{ end }}
    {{ end }}

    <div class="poster-cover">
      <!-- crossOrigin å¿…é¡»åŠ ï¼Œå¦åˆ™ html2canvas æ— æ³•å¤„ç†å›¾ç‰‡è£åˆ‡ -->
      <img src="{{ $posterImg }}" crossorigin="anonymous" id="hidden-poster-cover-img">
    </div>

    <div class="poster-content">
      <h2 class="poster-title">{{ .Title }}</h2>
      <div class="poster-info">
        <span class="poster-author">@{{ .Site.Params.author }}</span>
        <span class="poster-date">{{ .Date.Format "2006-01-02" }}</span>
      </div>
      <hr class="poster-divider">
      <div class="poster-footer">
        <div class="poster-desc"><p>é•¿æŒ‰è¯†åˆ«äºŒç»´ç </p><p>é˜…è¯»åŸæ–‡</p></div>
        <div id="poster-qrcode"></div>
      </div>
    </div>
  </div>
</div>

<!-- å¼¹çª— -->
<div id="poster-modal" onclick="closePosterModal()">
  <div class="poster-modal-content" onclick="event.stopPropagation()">
    <p style="color:white; margin-bottom:10px; font-size:14px; text-shadow:0 1px 2px black;">é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ†äº«</p>
    <img id="final-poster-img" src="" alt="Share Poster">
    
    <div id="poster-loading">
        <div class="loading-spinner"></div>
        <p id="loading-text">æ­£åœ¨åˆå§‹åŒ–ç»„ä»¶...</p>
    </div>
  </div>
  <div class="poster-close-btn" onclick="closePosterModal()">Ã—</div>
</div>

<style>
/* æ ·å¼éƒ¨åˆ† */
.share-button-circle { position: fixed; right: 15px; z-index: 9999; touch-action: none; }
.share-button-circle button { width: 50px; height: 50px; border-radius: 50%; background-color: #B9375D; color: #fff; border: none; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.2s, background-color 0.3s; }
.share-button-circle button:hover { background-color: #E45A92; transform: scale(1.05); }

#poster-source-container { position: fixed; top: 0; left: 0; width: 375px; z-index: -100; background-color: #fff; opacity: 0; pointer-events: none; }
.poster-card { background: #fff; border: 1px solid #eee; overflow: hidden; }

/* ğŸš¨ å°é¢å›¾å®¹å™¨æ ·å¼ */
.poster-cover { 
  width: 100%; 
  height: 200px; /* å›ºå®šé«˜åº¦ */
  overflow: hidden; 
  background: #f4f4f4; 
}

/* ğŸš¨ å°é¢å›¾æœ¬èº«æ ·å¼ï¼šå¼ºåˆ¶è£åˆ‡ */
.poster-cover img { 
  width: 100%; 
  height: 100%; 
  object-fit: cover; /* å…³é”®ï¼šä¿è¯ä¸æ‹‰ä¼¸ï¼Œå¡«æ»¡å®¹å™¨ */
  object-position: center; /* å±…ä¸­æ˜¾ç¤º */
  display: block;
}

.poster-content { padding: 20px; }
.poster-title { font-size: 20px; font-weight: bold; color: #333; line-height: 1.4; margin: 0 0 10px 0; text-align: left; }
.poster-info { color: #888; font-size: 13px; margin-bottom: 15px; }
.poster-divider { border: 0; border-top: 1px dashed #eee; margin: 15px 0; }
.poster-footer { display: flex; justify-content: space-between; align-items: center; }
.poster-desc { color: #666; font-size: 12px; line-height: 1.6; }
#poster-qrcode img { width: 75px !important; height: 75px !important; display: block; }

#poster-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.poster-modal-content { text-align: center; width: 80%; max-width: 375px; }
#final-poster-img { width: 100%; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: none; }
#poster-loading { color: white; font-size: 16px; margin-top: 20px; }
.poster-close-btn { position: absolute; bottom: 50px; width: 40px; height: 40px; border: 2px solid white; border-radius: 50%; color: white; font-size: 24px; text-align: center; line-height: 36px; cursor: pointer; opacity: 0.8; }
.loading-spinner { border: 4px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 4px solid #fff; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script>
// æœ¬åœ°åº“è·¯å¾„
const LIBS = {
  qrcode: "/js/qrcode.min.js",
  html2canvas: "/js/html2canvas.min.js"
};

function loadScript(src) {
  return new Promise((resolve, reject) => {
    if (document.querySelector(`script[src="${src}"]`)) { resolve(); return; }
    var script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.body.appendChild(script);
  });
}

// é¢„åŠ è½½
setTimeout(() => {
  if (window.innerWidth <= 768) {
    loadScript(LIBS.qrcode).catch(() => {});
    loadScript(LIBS.html2canvas).catch(() => {});
  }
}, 3000);

function handleShareClick(url) {
  if (window.innerWidth <= 768) {
    var modal = document.getElementById('poster-modal');
    var loading = document.getElementById('poster-loading');
    modal.style.display = 'flex';
    loading.style.display = 'block';

    Promise.all([
      loadScript(LIBS.qrcode),
      loadScript(LIBS.html2canvas)
    ]).then(() => {
      generatePoster(url);
    }).catch(err => {
      alert("ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•");
      closePosterModal();
    });

  } else {
    shareLinkPC(url);
  }
}

function shareLinkPC(url) {
  if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(url).then(() => alert("é“¾æ¥å·²å¤åˆ¶ï¼"), () => alert("å¤åˆ¶å¤±è´¥")); }
  else { const ta = document.createElement("textarea"); ta.value = url; ta.style.position = "fixed"; ta.style.top = "-9999px"; document.body.appendChild(ta); ta.focus(); ta.select(); try { document.execCommand('copy'); alert("é“¾æ¥å·²å¤åˆ¶ï¼"); } catch(e){ } document.body.removeChild(ta); }
}

var qrcodeGenerated = false;

function generatePoster(url) {
  var loadingText = document.getElementById('loading-text');
  var loading = document.getElementById('poster-loading');
  var finalImg = document.getElementById('final-poster-img');
  
  loadingText.innerText = "æ­£åœ¨å‡†å¤‡äºŒç»´ç ...";

  if (!qrcodeGenerated) {
    new QRCode(document.getElementById("poster-qrcode"), { text: url, width: 75, height: 75, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
    qrcodeGenerated = true;
  }

  loadingText.innerText = "æ­£åœ¨åŠ è½½å›¾ç‰‡...";
  var hiddenImg = document.getElementById('hidden-poster-cover-img');
  
  var imgLoadPromise = new Promise((resolve, reject) => {
    if (hiddenImg.complete && hiddenImg.naturalHeight !== 0) { resolve(); }
    else { hiddenImg.onload = () => resolve(); hiddenImg.onerror = () => { console.warn("å°é¢å¤±è´¥"); resolve(); }; }
  });
  
  var timeoutPromise = new Promise((resolve) => setTimeout(resolve, 3000));

  Promise.race([imgLoadPromise, timeoutPromise]).then(() => {
    loadingText.innerText = "æ­£åœ¨ç»˜åˆ¶æµ·æŠ¥...";
    
    setTimeout(() => {
      var posterCard = document.querySelector(".poster-card");
      html2canvas(posterCard, { 
        useCORS: true, 
        allowTaint: false, 
        scale: 2, 
        backgroundColor: "#ffffff",
        logging: false 
      }).then(canvas => {
        try {
            var dataUrl = canvas.toDataURL("image/png");
            finalImg.src = dataUrl;
            finalImg.onload = function() { loading.style.display = 'none'; finalImg.style.display = 'block'; }
            setTimeout(() => { 
                if(finalImg.style.display === 'none') {
                    loading.style.display = 'none'; finalImg.style.display = 'block'; 
                }
            }, 200);
        } catch(e) {
            alert("ç”Ÿæˆå¤±è´¥ï¼šå›¾ç‰‡è·¨åŸŸé™åˆ¶");
            closePosterModal();
        }
      }).catch(err => { 
        alert("ç»˜åˆ¶é”™è¯¯: " + err); 
        closePosterModal(); 
      });
    }, 100);
  });
}
function closePosterModal() { document.getElementById('poster-modal').style.display = 'none'; }

// æ‹–æ‹½
(function() {
  const btn = document.getElementById("share-button"); let isDragging = false; let startY, startTop;
  btn.addEventListener("mousedown", function(e) { isDragging = true; startY = e.clientY; startTop = btn.offsetTop; e.preventDefault(); });
  document.addEventListener("mousemove", function(e) { if (!isDragging) return; let deltaY = e.clientY - startY; let newTop = startTop + deltaY; newTop = Math.max(0, Math.min(window.innerHeight - btn.offsetHeight, newTop)); btn.style.top = newTop + "px"; });
  document.addEventListener("mouseup", function(){ isDragging = false; });
  btn.addEventListener("touchstart", function(e){ isDragging = true; startY = e.touches[0].clientY; startTop = btn.offsetTop; });
  btn.addEventListener("touchmove", function(e){ if (!isDragging) return; e.preventDefault(); let deltaY = e.touches[0].clientY - startY; let newTop = startTop + deltaY; newTop = Math.max(0, Math.min(window.innerHeight - btn.offsetHeight, newTop)); btn.style.top = newTop + "px"; });
  btn.addEventListener("touchend", function(){ isDragging = false; });
})();
</script>