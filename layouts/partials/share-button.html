<!-- å¼•å…¥åº“ -->
<script src="https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- æ‚¬æµ®æŒ‰é’® -->
<div id="share-button" class="share-button-circle" style="top: 50%;">
  <button onclick="handleShareClick('{{ .Permalink }}')" title="åˆ†äº«/ç”Ÿæˆæµ·æŠ¥">
    <i class="fas fa-share-alt"></i>
  </button>
</div>

<!-- æµ·æŠ¥æº (éšè—ç»“æ„) -->
<div id="poster-source-container">
  <div class="poster-card">
    
    <!-- å›¾ç‰‡è·¯å¾„é€»è¾‘ -->
    {{ $posterImg := "" }}
    {{ if .Params.thumbnail }}
      {{ $img := .Resources.GetMatch .Params.thumbnail }}
      {{ if $img }}
        {{ $posterImg = ($img.Resize "800x q90").Permalink }}
      {{ else }}
        {{/* é’ˆå¯¹æ—§æ–‡ç« çš„å…¼å®¹ï¼šå¼ºåˆ¶è½¬ä¸ºç»å¯¹è·¯å¾„ */}}
        {{ $posterImg = (.Params.thumbnail | absURL) }}
      {{ end }}
    {{ else if .Params.image }}
      {{ $img := .Resources.GetMatch .Params.image }}
      {{ if $img }}
        {{ $posterImg = ($img.Resize "800x q90").Permalink }}
      {{ else }}
        {{ $posterImg = (.Params.image | absURL) }}
      {{ end }}
    {{ else }}
      {{ $posterImg = "/images/profile.png" | absURL }}
    {{ end }}

    <div class="poster-cover">
      <!-- ç»™ img åŠ ä¸€ä¸ª idï¼Œæ–¹ä¾¿ JS æŠ“å–å®ƒ -->
      <img src="{{ $posterImg }}" crossorigin="anonymous" id="hidden-poster-cover-img">
    </div>

    <div class="poster-content">
      <h2 class="poster-title">{{ .Title }}</h2>
      <div class="poster-info">
        <span class="poster-author">@{{ .Site.Params.author }}</span>
        <span class="poster-date">{{ .Date.Format "2006-01-02" }}</span>
      </div>
      <hr class="poster-divider">
      <div class="poster-footer">
        <div class="poster-desc">
          <p>é•¿æŒ‰è¯†åˆ«äºŒç»´ç </p>
          <p>é˜…è¯»åŸæ–‡</p>
        </div>
        <div id="poster-qrcode"></div>
      </div>
    </div>
  </div>
</div>

<!-- å¼¹çª— -->
<div id="poster-modal" onclick="closePosterModal()">
  <div class="poster-modal-content" onclick="event.stopPropagation()">
    <p style="color:white; margin-bottom:10px; font-size:14px; text-shadow:0 1px 2px black;">é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ†äº«</p>
    <img id="final-poster-img" src="" alt="Share Poster">
    
    <!-- Loading çŠ¶æ€æç¤º -->
    <div id="poster-loading">
        <div class="loading-spinner"></div>
        <p id="loading-text">æ­£åœ¨åŠ è½½å°é¢å›¾...</p>
    </div>
  </div>
  <div class="poster-close-btn" onclick="closePosterModal()">Ã—</div>
</div>

<style>
/* æ ·å¼éƒ¨åˆ† */
.share-button-circle { position: fixed; right: 15px; z-index: 9999; touch-action: none; }
.share-button-circle button { width: 50px; height: 50px; border-radius: 50%; background-color: #B9375D; color: #fff; border: none; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.2s, background-color 0.3s; }
.share-button-circle button:hover { background-color: #E45A92; transform: scale(1.05); }

/* è¿™é‡Œç”¨ opacity:0 ä»£æ›¿ left:-9999pxï¼Œé˜²æ­¢éƒ¨åˆ†æµè§ˆå™¨ä¸åŠ è½½å±å¹•å¤–çš„å›¾ç‰‡ */
#poster-source-container { position: fixed; top: 0; left: 0; width: 375px; z-index: -100; background-color: #fff; opacity: 0; pointer-events: none; }

.poster-card { background: #fff; border: 1px solid #eee; overflow: hidden; }
.poster-cover { width: 100%; height: 200px; overflow: hidden; background: #f4f4f4; }
.poster-cover img { width: 100%; height: 100%; object-fit: cover; }
.poster-content { padding: 20px; }
.poster-title { font-size: 20px; font-weight: bold; color: #333; line-height: 1.4; margin: 0 0 10px 0; text-align: left; }
.poster-info { color: #888; font-size: 13px; margin-bottom: 15px; }
.poster-divider { border: 0; border-top: 1px dashed #eee; margin: 15px 0; }
.poster-footer { display: flex; justify-content: space-between; align-items: center; }
.poster-desc { color: #666; font-size: 12px; line-height: 1.6; }
#poster-qrcode img { width: 75px !important; height: 75px !important; display: block; }

#poster-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.poster-modal-content { text-align: center; width: 80%; max-width: 375px; }
#final-poster-img { width: 100%; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: none; }
#poster-loading { color: white; font-size: 16px; margin-top: 20px; }
.poster-close-btn { position: absolute; bottom: 50px; width: 40px; height: 40px; border: 2px solid white; border-radius: 50%; color: white; font-size: 24px; text-align: center; line-height: 36px; cursor: pointer; opacity: 0.8; }

/* ç®€å•çš„è½¬åœˆåŠ¨ç”» */
.loading-spinner { border: 4px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 4px solid #fff; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script>
// ç‚¹å‡»å…¥å£
function handleShareClick(url) {
  if (window.innerWidth <= 768) {
    generatePoster(url);
  } else {
    shareLinkPC(url);
  }
}

// PC å¤åˆ¶é“¾æ¥
function shareLinkPC(url) {
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(url).then(() => alert("é“¾æ¥å·²å¤åˆ¶ï¼"), () => alert("å¤åˆ¶å¤±è´¥: " + url));
  } else {
    const ta = document.createElement("textarea");
    ta.value = url; ta.style.position = "fixed"; ta.style.top = "-9999px";
    document.body.appendChild(ta); ta.focus(); ta.select();
    try { document.execCommand('copy'); alert("é“¾æ¥å·²å¤åˆ¶ï¼"); } catch(e){ alert("å¤åˆ¶å¤±è´¥"); }
    document.body.removeChild(ta);
  }
}

var qrcodeGenerated = false;

// ğŸš€ æ ¸å¿ƒï¼šæ™ºèƒ½ç”Ÿæˆæµ·æŠ¥
function generatePoster(url) {
  var modal = document.getElementById('poster-modal');
  var loadingText = document.getElementById('loading-text');
  var loading = document.getElementById('poster-loading');
  var finalImg = document.getElementById('final-poster-img');
  
  // 1. åˆå§‹åŒ–å¼¹çª—
  modal.style.display = 'flex';
  loading.style.display = 'block';
  finalImg.style.display = 'none';
  loadingText.innerText = "æ­£åœ¨å‡†å¤‡äºŒç»´ç ...";

  // 2. ç”ŸæˆäºŒç»´ç  (ä»…ä¸€æ¬¡)
  if (!qrcodeGenerated) {
    if (typeof QRCode === 'undefined') { alert("äºŒç»´ç ç»„ä»¶åŠ è½½å¤±è´¥"); return; }
    new QRCode(document.getElementById("poster-qrcode"), {
      text: url, width: 75, height: 75,
      colorDark : "#000000", colorLight : "#ffffff",
      correctLevel : QRCode.CorrectLevel.H
    });
    qrcodeGenerated = true;
  }

  // 3. æ™ºèƒ½ç­‰å¾…å›¾ç‰‡åŠ è½½
  loadingText.innerText = "æ­£åœ¨åŠ è½½å›¾ç‰‡...";
  
  // è·å–é‚£å¼ éšå½¢æµ·æŠ¥é‡Œçš„å°é¢å›¾
  var hiddenImg = document.getElementById('hidden-poster-cover-img');
  
  // åˆ›å»ºä¸€ä¸ª Promise æ¥ç­‰å¾…å›¾ç‰‡åŠ è½½
  var imgLoadPromise = new Promise((resolve, reject) => {
    if (hiddenImg.complete && hiddenImg.naturalHeight !== 0) {
      resolve(); // å›¾ç‰‡å·²ç»åœ¨ç¼“å­˜é‡Œäº†ï¼Œç›´æ¥é€šè¿‡
    } else {
      hiddenImg.onload = () => resolve(); // å›¾ç‰‡åŠ è½½å®Œæˆæ—¶è§¦å‘
      hiddenImg.onerror = () => {
        console.warn("æµ·æŠ¥å°é¢åŠ è½½å¤±è´¥ï¼Œå°†ç”Ÿæˆæ— å›¾æµ·æŠ¥");
        resolve(); // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­ï¼Œä¸è¦å¡æ­»ï¼Œåªæ˜¯æ²¡æœ‰å›¾è€Œå·²
      };
    }
  });

  // è®¾ç½®ä¸€ä¸ªè¶…æ—¶ï¼Œä¸‡ä¸€å›¾ç‰‡ 5ç§’ éƒ½æ²¡ä¸‹æ¥ï¼Œå°±ä¸ç­‰äº†
  var timeoutPromise = new Promise((resolve) => setTimeout(resolve, 5000));

  // ç«é€Ÿï¼šå›¾ç‰‡åŠ è½½ vs è¶…æ—¶
  Promise.race([imgLoadPromise, timeoutPromise]).then(() => {
    loadingText.innerText = "æ­£åœ¨ç»˜åˆ¶æµ·æŠ¥...";
    
    // å¼€å§‹æˆªå›¾
    // ç¨å¾®å»¶è¿Ÿ 100ms è®©æ¸²æŸ“å¼•æ“å–˜å£æ°”
    setTimeout(() => {
      var posterCard = document.querySelector(".poster-card");
      if (typeof html2canvas === 'undefined') { alert("ç»˜å›¾ç»„ä»¶åŠ è½½å¤±è´¥"); return; }

      html2canvas(posterCard, {
        useCORS: true,
        allowTaint: true,
        scale: 2,
        backgroundColor: "#ffffff",
        scrollY: 0,
        scrollX: 0
      }).then(canvas => {
        var dataUrl = canvas.toDataURL("image/png");
        finalImg.src = dataUrl;
        
        // å›¾ç‰‡ç”Ÿæˆå®Œæ¯•
        finalImg.onload = function() {
            loading.style.display = 'none';
            finalImg.style.display = 'block';
        }
        // å…œåº•æ˜¾ç¤º
        setTimeout(() => {
             loading.style.display = 'none';
             finalImg.style.display = 'block';
        }, 100);
      }).catch(err => {
        alert("æµ·æŠ¥ç»˜åˆ¶å‡ºé”™: " + err);
        modal.style.display = 'none';
      });
    }, 100);
  });
}

function closePosterModal() {
  document.getElementById('poster-modal').style.display = 'none';
}

// æ‹–æ‹½é€»è¾‘ (ä¿æŒä¸å˜)
(function() {
  const btn = document.getElementById("share-button");
  let isDragging = false; let startY, startTop;
  btn.addEventListener("mousedown", function(e) { isDragging = true; startY = e.clientY; startTop = btn.offsetTop; e.preventDefault(); });
  document.addEventListener("mousemove", function(e) { if (!isDragging) return; let deltaY = e.clientY - startY; let newTop = startTop + deltaY; newTop = Math.max(0, Math.min(window.innerHeight - btn.offsetHeight, newTop)); btn.style.top = newTop + "px"; });
  document.addEventListener("mouseup", function(){ isDragging = false; });
  btn.addEventListener("touchstart", function(e){ isDragging = true; startY = e.touches[0].clientY; startTop = btn.offsetTop; });
  btn.addEventListener("touchmove", function(e){ if (!isDragging) return; e.preventDefault(); let deltaY = e.touches[0].clientY - startY; let newTop = startTop + deltaY; newTop = Math.max(0, Math.min(window.innerHeight - btn.offsetHeight, newTop)); btn.style.top = newTop + "px"; });
  btn.addEventListener("touchend", function(){ isDragging = false; });
})();
</script>