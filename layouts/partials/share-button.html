<!-- ğŸš€ ä¼˜åŒ– 1: æ¢ç”¨å›½å†… BootCDNï¼ŒåŠ è½½é€Ÿåº¦æ›´å¿«æ›´ç¨³ -->
<script src="https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- æ‚¬æµ®æŒ‰é’® (ä¿æŒä¸å˜) -->
<div id="share-button" class="share-button-circle" style="top: 50%;">
  <button onclick="handleShareClick('{{ .Permalink }}')" title="åˆ†äº«/ç”Ÿæˆæµ·æŠ¥">
    <i class="fas fa-share-alt"></i>
  </button>
</div>

<!-- æµ·æŠ¥æºç»“æ„ (éšè—) -->
<div id="poster-source-container">
  <div class="poster-card">
    <!-- ğŸš€ ä¼˜åŒ– 2: å›¾ç‰‡é€»è¾‘ä¼˜åŒ–ï¼Œä½¿ç”¨ absURL (ç»å¯¹è·¯å¾„) -->
    {{ $posterImg := "" }}
    {{ if .Params.thumbnail }}
      {{ $img := .Resources.GetMatch .Params.thumbnail }}
      {{ if $img }}
        {{/* ä½¿ç”¨ Permalink è·å–å®Œæ•´çš„ https é“¾æ¥ï¼Œhtml2canvas æ›´å–œæ¬¢è¿™ä¸ª */}}
        {{ $posterImg = ($img.Resize "800x q90").Permalink }}
      {{ else }}
        {{ $posterImg = (.Params.thumbnail | absURL) }}
      {{ end }}
    {{ else if .Params.image }}
      {{ $img := .Resources.GetMatch .Params.image }}
      {{ if $img }}
        {{ $posterImg = ($img.Resize "800x q90").Permalink }}
      {{ else }}
        {{ $posterImg = (.Params.image | absURL) }}
      {{ end }}
    {{ else }}
      <!-- âš ï¸ ç¡®ä¿è¿™ä¸ªé»˜è®¤å›¾å­˜åœ¨ï¼å¦åˆ™æµ·æŠ¥ä¼šç™½å± -->
      {{ $posterImg = "/images/profile.png" | absURL }}
    {{ end }}

    <div class="poster-cover">
      <!-- å¢åŠ  crossOrigin å±æ€§ï¼Œé˜²æ­¢ç”»å¸ƒè¢«æ±¡æŸ“ -->
      <img src="{{ $posterImg }}" crossorigin="anonymous" id="hidden-poster-img">
    </div>

    <div class="poster-content">
      <h2 class="poster-title">{{ .Title }}</h2>
      <div class="poster-info">
        <span class="poster-author">@{{ .Site.Params.author }}</span>
        <span class="poster-date">{{ .Date.Format "2006-01-02" }}</span>
      </div>
      <hr class="poster-divider">
      <div class="poster-footer">
        <div class="poster-desc">
          <p>é•¿æŒ‰è¯†åˆ«äºŒç»´ç </p>
          <p>é˜…è¯»åŸæ–‡</p>
        </div>
        <div id="poster-qrcode"></div>
      </div>
    </div>
  </div>
</div>

<!-- ç»“æœå¼¹çª— -->
<div id="poster-modal" onclick="closePosterModal()">
  <div class="poster-modal-content" onclick="event.stopPropagation()">
    <p style="color:white; margin-bottom:10px; font-size:14px; text-shadow:0 1px 2px black;">é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ†äº«</p>
    <img id="final-poster-img" src="" alt="Share Poster">
    <div id="poster-loading">
        <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨ç”Ÿæˆæµ·æŠ¥...
    </div>
  </div>
  <div class="poster-close-btn" onclick="closePosterModal()">Ã—</div>
</div>

<style>
/* æ ·å¼ä¿æŒä¸å˜ï¼Œä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œå¤ç”¨ä½ ä¸Šä¸€æ¬¡çš„ CSS */
/* ...è¯·ç¡®ä¿ä¿ç•™äº†åŸæ¥çš„ CSS æ ·å¼... */
/* å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥æŠŠ CSS å†è´´ä¸€éï¼Œä½†åŸåˆ™ä¸Šåˆšæ‰çš„ CSS æ²¡é—®é¢˜ */

.share-button-circle { position: fixed; right: 15px; z-index: 9999; touch-action: none; }
.share-button-circle button { width: 50px; height: 50px; border-radius: 50%; background-color: #B9375D; color: #fff; border: none; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.2s, background-color 0.3s; }
.share-button-circle button:hover { background-color: #E45A92; transform: scale(1.05); }
#poster-source-container { position: fixed; top: 0; left: -9999px; width: 375px; z-index: -1; background-color: #fff; }
.poster-card { background: #fff; border: 1px solid #eee; overflow: hidden; }
.poster-cover { width: 100%; height: 200px; overflow: hidden; background: #f4f4f4; }
.poster-cover img { width: 100%; height: 100%; object-fit: cover; }
.poster-content { padding: 20px; }
.poster-title { font-size: 20px; font-weight: bold; color: #333; line-height: 1.4; margin: 0 0 10px 0; text-align: left; }
.poster-info { color: #888; font-size: 13px; margin-bottom: 15px; }
.poster-divider { border: 0; border-top: 1px dashed #eee; margin: 15px 0; }
.poster-footer { display: flex; justify-content: space-between; align-items: center; }
.poster-desc { color: #666; font-size: 12px; line-height: 1.6; }
#poster-qrcode img { width: 75px !important; height: 75px !important; display: block; }
#poster-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
.poster-modal-content { text-align: center; width: 80%; max-width: 375px; }
#final-poster-img { width: 100%; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: none; }
#poster-loading { color: white; font-size: 16px; margin-top: 20px; }
.poster-close-btn { position: absolute; bottom: 50px; width: 40px; height: 40px; border: 2px solid white; border-radius: 50%; color: white; font-size: 24px; text-align: center; line-height: 36px; cursor: pointer; opacity: 0.8; }
</style>

<script>
function handleShareClick(url) {
  // ç®€å•åˆ¤æ–­ç§»åŠ¨ç«¯
  if (window.innerWidth <= 768) {
    generatePoster(url);
  } else {
    shareLinkPC(url);
  }
}

function shareLinkPC(url) {
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(url).then(() => alert("é“¾æ¥å·²å¤åˆ¶ï¼"), () => alert("å¤åˆ¶å¤±è´¥: " + url));
  } else {
    // å…¼å®¹æ—§æµè§ˆå™¨
    const ta = document.createElement("textarea");
    ta.value = url; ta.style.position = "fixed"; ta.style.top = "-9999px";
    document.body.appendChild(ta); ta.focus(); ta.select();
    try { document.execCommand('copy'); alert("é“¾æ¥å·²å¤åˆ¶ï¼"); } catch(e){ alert("å¤åˆ¶å¤±è´¥"); }
    document.body.removeChild(ta);
  }
}

// ----------------------------------------------------
// æµ·æŠ¥ç”Ÿæˆæ ¸å¿ƒé€»è¾‘ (V2 ä¿®å¤ç‰ˆ)
// ----------------------------------------------------
var qrcodeGenerated = false;

function generatePoster(url) {
  var modal = document.getElementById('poster-modal');
  var loading = document.getElementById('poster-loading');
  var finalImg = document.getElementById('final-poster-img');
  
  // 1. æ˜¾ç¤ºå¼¹çª— & Loading
  modal.style.display = 'flex';
  loading.style.display = 'block';
  finalImg.style.display = 'none';

  // 2. ç”ŸæˆäºŒç»´ç  (ä»…ä¸€æ¬¡)
  if (!qrcodeGenerated) {
    // æ£€æŸ¥ QRCode åº“æ˜¯å¦åŠ è½½æˆåŠŸ
    if (typeof QRCode === 'undefined') {
      alert("é”™è¯¯ï¼šäºŒç»´ç ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚");
      modal.style.display = 'none';
      return;
    }
    
    new QRCode(document.getElementById("poster-qrcode"), {
      text: url, width: 75, height: 75,
      colorDark : "#000000", colorLight : "#ffffff",
      correctLevel : QRCode.CorrectLevel.H
    });
    qrcodeGenerated = true;
  }

  // 3. ğŸš€ å…³é”®ä¿®æ”¹ï¼šç­‰å¾… 1000ms (1ç§’) ç¡®ä¿å›¾ç‰‡åœ¨ DOM ä¸­æ¸²æŸ“å®Œæ¯•
  // æ‰‹æœºæ€§èƒ½å·®æˆ–ç½‘é€Ÿæ…¢æ—¶ï¼Œ300ms å¾€å¾€ä¸å¤Ÿï¼Œå¯¼è‡´æˆªå›¾ä¸ºç©º
  setTimeout(function() {
    
    // æ£€æŸ¥ html2canvas æ˜¯å¦åŠ è½½
    if (typeof html2canvas === 'undefined') {
      alert("é”™è¯¯ï¼šç»˜å›¾ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
      modal.style.display = 'none';
      return;
    }

    var posterCard = document.querySelector(".poster-card");

    // å¼€å§‹æˆªå›¾
    html2canvas(posterCard, {
      useCORS: true,       // å…è®¸è·¨åŸŸå›¾ç‰‡
      allowTaint: true,    // å…è®¸æ±¡æŸ“ (æœ‰æ—¶èƒ½è§£å†³ CORS æŠ¥é”™)
      scale: 2,            // 2å€æ¸…æ™°åº¦
      backgroundColor: "#ffffff", // ç¡®ä¿èƒŒæ™¯æ˜¯ç™½çš„ä¸æ˜¯é€æ˜çš„
      scrollY: 0,          // ä¿®å¤é¡µé¢æ»šåŠ¨å¯¼è‡´æˆªå›¾åç§»çš„é—®é¢˜
      scrollX: 0
    }).then(canvas => {
      try {
        var dataUrl = canvas.toDataURL("image/png");
        finalImg.src = dataUrl;
        
        // åªæœ‰å½“å›¾ç‰‡ src èµ‹å€¼æˆåŠŸåï¼Œæ‰æ˜¾ç¤º
        finalImg.onload = function() {
            loading.style.display = 'none';
            finalImg.style.display = 'block';
        }
        // é˜²æ­¢ onload ä¸è§¦å‘ï¼ˆæ¯”å¦‚å·²ç»ç¼“å­˜ï¼‰ï¼Œæ‰‹åŠ¨å…œåº•
        setTimeout(() => {
             loading.style.display = 'none';
             finalImg.style.display = 'block';
        }, 200);

      } catch (e) {
        alert("æµ·æŠ¥ç”Ÿæˆè¢«æµè§ˆå™¨æ‹¦æˆª (CORS)ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡è·¨åŸŸé—®é¢˜ã€‚");
        console.error(e);
        modal.style.display = 'none';
      }
    }).catch(err => {
      console.error("ç”Ÿæˆå¤±è´¥:", err);
      alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: " + err);
      modal.style.display = 'none';
    });

  }, 1000); // â³ è¿™é‡Œæ”¹æˆäº† 1000ms
}

function closePosterModal() {
  document.getElementById('poster-modal').style.display = 'none';
}

// æ‹–æ‹½é€»è¾‘ (ä¿æŒä¸å˜)
(function() {
  const btn = document.getElementById("share-button");
  let isDragging = false; let startY, startTop;
  btn.addEventListener("mousedown", function(e) { isDragging = true; startY = e.clientY; startTop = btn.offsetTop; e.preventDefault(); });
  document.addEventListener("mousemove", function(e) { if (!isDragging) return; let deltaY = e.clientY - startY; let newTop = startTop + deltaY; newTop = Math.max(0, Math.min(window.innerHeight - btn.offsetHeight, newTop)); btn.style.top = newTop + "px"; });
  document.addEventListener("mouseup", function(){ isDragging = false; });
  btn.addEventListener("touchstart", function(e){ isDragging = true; startY = e.touches[0].clientY; startTop = btn.offsetTop; });
  btn.addEventListener("touchmove", function(e){ if (!isDragging) return; e.preventDefault(); let deltaY = e.touches[0].clientY - startY; let newTop = startTop + deltaY; newTop = Math.max(0, Math.min(window.innerHeight - btn.offsetHeight, newTop)); btn.style.top = newTop + "px"; });
  btn.addEventListener("touchend", function(){ isDragging = false; });
})();
</script>